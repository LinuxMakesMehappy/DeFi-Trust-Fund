name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Rust
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
        override: true
    
    - name: Setup Solana
      run: |
        sh -c "$(curl -sSfL https://release.solana.com/v1.16.0/install)"
        echo "$HOME/.local/share/solana/install/active_release/bin" >> $GITHUB_PATH
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install Anchor
      run: |
        npm install -g @coral-xyz/anchor-cli@0.29.0
    
    - name: Install dependencies
      run: |
        npm install
    
    - name: Build
      run: |
        anchor build
    
    - name: Run tests
      run: |
        anchor test --skip-local-validator
    
    - name: Run security tests
      run: |
        npm run test:security
    
    - name: Run linting
      run: |
        cargo clippy --all-targets --all-features -- -D warnings
    
    - name: Check formatting
      run: |
        cargo fmt --all -- --check

  security:
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Rust
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
        override: true
    
    - name: Setup Solana
      run: |
        sh -c "$(curl -sSfL https://release.solana.com/v1.16.0/install)"
        echo "$HOME/.local/share/solana/install/active_release/bin" >> $GITHUB_PATH
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install Anchor
      run: |
        npm install -g @coral-xyz/anchor-cli@0.29.0
    
    - name: Install dependencies
      run: |
        npm install
    
    - name: Run security audit
      run: |
        npm run security:audit
    
    - name: Run overflow tests
      run: |
        npm run test:overflow
    
    - name: Run access control tests
      run: |
        npm run test:access-control
    
    - name: Run emergency control tests
      run: |
        npm run test:emergency-controls

  build:
    runs-on: ubuntu-latest
    needs: [test, security]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Rust
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
        override: true
    
    - name: Setup Solana
      run: |
        sh -c "$(curl -sSfL https://release.solana.com/v1.16.0/install)"
        echo "$HOME/.local/share/solana/install/active_release/bin" >> $GITHUB_PATH
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install Anchor
      run: |
        npm install -g @coral-xyz/anchor-cli@0.29.0
    
    - name: Install dependencies
      run: |
        npm install
    
    - name: Build for release
      run: |
        anchor build --release
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: defi-trust-fund-build
        path: |
          target/deploy/defi_trust_fund.so
          target/idl/defi_trust_fund.json
          target/types/defi_trust_fund.ts
